# MQTT Gear Server

ä¸€å€‹åŸºæ–¼ MQTT çš„é½’è¼ªæŒ¯å‹•åˆ†æç³»çµ±ï¼Œå¯¦ç¾æ¼”ç®—æ³•ç«¯ï¼ˆAï¼‰èˆ‡åŸ·è¡Œç«¯ï¼ˆBï¼‰ä¹‹é–“çš„å³æ™‚é€šä¿¡å’Œæ•¸æ“šäº¤æ›ã€‚

## å°ˆæ¡ˆçµæ§‹

```
mqtt_gear_server/
â”œâ”€ broker/                     # MQTT Broker (Mosquitto)
â”‚  â”œâ”€ docker-compose.yml       # Docker Compose é…ç½®
â”‚  â”œâ”€ mosquitto.conf          # Mosquitto é…ç½®
â”‚  â”œâ”€ acl                     # è¨ªå•æ§åˆ¶åˆ—è¡¨
â”‚  â”œâ”€ passwd                  # ç”¨æˆ¶å¯†ç¢¼æ–‡ä»¶ (éœ€ç”Ÿæˆ)
â”‚  â””â”€ certs/                  # TLS æ†‘è­‰ç›®éŒ„
â”œâ”€ client-python-A/           # Aç«¯ - Python æ¼”ç®—æ³•å®¢æˆ¶ç«¯
â”‚  â”œâ”€ a_client.py             # ä¸»ç¨‹åº
â”‚  â””â”€ requirements.txt        # Python ä¾è³´
â”œâ”€ client-csharp-B/           # Bç«¯ - C# åŸ·è¡Œå®¢æˆ¶ç«¯
â”‚  â”œâ”€ Program.cs              # ä¸»ç¨‹åº
â”‚  â””â”€ BClient.csproj          # å°ˆæ¡ˆæ–‡ä»¶
â””â”€ setup.sh                   # åˆå§‹åŒ–è…³æœ¬
```

## ç³»çµ±ç‰¹æ€§

### ğŸ”„ Request/Response æ¨¡å¼
- A ç«¯ç™¼é€ `cmd/point` æŒ‡ä»¤å¾Œ**é˜»å¡ç­‰å¾…** B ç«¯çš„ `telemetry/result`
- ä½¿ç”¨ `req_id` (UUID) é—œè¯è«‹æ±‚èˆ‡å›æ‡‰ï¼Œç¢ºä¿æ¶ˆæ¯å°æ‡‰
- æ”¯æŒ**é€¾æ™‚é‡è©¦**å’Œ**å¹‚ç­‰æ€§**ä¿è­‰

### ğŸ“¡ MQTT Topic è¨­è¨ˆ
- `v1/{id}/ctrl/start` - Bâ†’Aï¼Œè§¸ç™¼æµç¨‹é–‹å§‹
- `v1/{id}/ctrl/end` - Aâ†’Bï¼Œæµç¨‹çµæŸä¿¡è™Ÿ  
- `v1/{id}/cmd/point` - Aâ†’Bï¼Œé»ä½ç§»å‹•æŒ‡ä»¤
- `v1/{id}/telemetry/result` - Bâ†’Aï¼ŒæŒ¯å‹•åˆ†æçµæœ
- `v1/{id}/config/setting` - é›™å‘ï¼Œç³»çµ±é…ç½® (retained)
- `v1/{id}/status` - è¨­å‚™ç‹€æ…‹ (retained)

### ğŸ”’ å®‰å…¨ç‰¹æ€§
- **ACL æ¬Šé™æ§åˆ¶**ï¼šAã€B ç”¨æˆ¶åªèƒ½è¨ªå•æˆæ¬Šçš„ Topic
- **TLS æ”¯æŒ**ï¼šå¯é…ç½®åŠ å¯†å‚³è¼¸ï¼ˆ8883 ç«¯å£ï¼‰
- **ç”¨æˆ¶é©—è­‰**ï¼šåŸºæ–¼ç”¨æˆ¶å/å¯†ç¢¼çš„èº«ä»½é©—è­‰

### ğŸ›¡ï¸ å¯é æ€§ä¿è­‰
- **QoS 1/2**ï¼šç¢ºä¿é‡è¦æ¶ˆæ¯é€é”
- **Retained Messages**ï¼šç‹€æ…‹å’Œé…ç½®æ¶ˆæ¯æŒä¹…åŒ–
- **éºå›‘æ¶ˆæ¯**ï¼šè¨­å‚™é›¢ç·šè‡ªå‹•é€šçŸ¥
- **éŒ¯èª¤è™•ç†**ï¼šå®Œå–„çš„ç•°å¸¸è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶

## ğŸš€ å¿«é€Ÿé–‹å§‹

### æ–¹æ³• 1: ğŸ³ Docker ä¸€éµéƒ¨ç½² (æ¨è–¦)

```bash
# é€²å…¥ broker ç›®éŒ„
cd broker

# ä¸€éµéƒ¨ç½²é–‹ç™¼ç’°å¢ƒ
./deploy.sh dev

# æˆ–éƒ¨ç½²ç”Ÿç”¢ç’°å¢ƒ (åŒ…å«ç›£æ§)
./deploy.sh prod

# æª¢æŸ¥éƒ¨ç½²ç‹€æ…‹
./monitor.sh
```

### æ–¹æ³• 2: ğŸ“‹ æ‰‹å‹•éƒ¨ç½²

#### 1. ç’°å¢ƒæº–å‚™

**å®‰è£ä¾è³´ï¼š**
```bash
# macOS
brew install mosquitto docker

# Ubuntu  
sudo apt-get install mosquitto-clients docker.io docker-compose

# Python ä¾è³´
cd client-python-A
pip install -r requirements.txt

# .NET ä¾è³´ (éœ€è¦ .NET 8.0)
cd client-csharp-B
dotnet restore
```

#### 2. åˆå§‹åŒ–ç³»çµ±

```bash
# åŸ·è¡Œåˆå§‹åŒ–è…³æœ¬
chmod +x setup.sh
./setup.sh
```

æ­¤è…³æœ¬æœƒï¼š
- å‰µå»º MQTT ç”¨æˆ¶å¯†ç¢¼æ–‡ä»¶
- è¨­ç½®å¿…è¦çš„ç›®éŒ„æ¬Šé™  
- æä¾›å¾ŒçºŒå•Ÿå‹•æŒ‡å¼•

#### 3. å•Ÿå‹•ç³»çµ±

**æ­¥é©Ÿ 1: å•Ÿå‹• MQTT Broker**
```bash
cd broker
docker compose up -d

# æŸ¥çœ‹æ—¥èªŒ
docker compose logs -f

# æˆ–ä½¿ç”¨ç›£æ§è…³æœ¬
./monitor.sh watch
```

**æ­¥é©Ÿ 2: å•Ÿå‹• B ç«¯ï¼ˆåŸ·è¡Œç«¯ï¼‰**
```bash
cd client-csharp-B
dotnet run
```

**æ­¥é©Ÿ 3: å•Ÿå‹• A ç«¯ï¼ˆæ¼”ç®—æ³•ç«¯ï¼‰**  
```bash
cd client-python-A
python a_client.py
```

### 4. ç³»çµ±é‹è¡Œæµç¨‹

1. **B ç«¯é€£æ¥** â†’ ç™¼é€ä¸Šç·šç‹€æ…‹å’Œåˆå§‹é…ç½®
2. **A ç«¯é€£æ¥** â†’ è¨‚é–±ç›¸é—œ Topic
3. **B ç«¯è§¸ç™¼** â†’ ç™¼é€ `start` ä¿¡è™Ÿçµ¦ A ç«¯
4. **A ç«¯åŸ·è¡Œ** â†’ ä¾åºç™¼é€é»ä½æŒ‡ä»¤ä¸¦ç­‰å¾…çµæœ
5. **B ç«¯éŸ¿æ‡‰** â†’ åŸ·è¡Œç§»å‹•å’Œåˆ†æï¼Œå›å‚³çµæœ
6. **æµç¨‹çµæŸ** â†’ A ç«¯ç™¼é€ `end` ä¿¡è™Ÿ

## é…ç½®èªªæ˜

### MQTT Broker é…ç½®

**åŸºæœ¬é€£æ¥ï¼š**
- åœ°å€ï¼š`127.0.0.1:1883` (éåŠ å¯†)
- TLSï¼š`127.0.0.1:8883` (éœ€é…ç½®æ†‘è­‰)
- WebSocketï¼š`127.0.0.1:9001` (å¯é¸)

**ç”¨æˆ¶æ¬Šé™ï¼š**
- `A_user`ï¼šæ¼”ç®—æ³•ç«¯ï¼Œå¯ç™¼é€æŒ‡ä»¤ã€æ¥æ”¶çµæœ
- `B_user`ï¼šåŸ·è¡Œç«¯ï¼Œå¯æ¥æ”¶æŒ‡ä»¤ã€ç™¼é€çµæœ

### å®¢æˆ¶ç«¯é…ç½®

**A ç«¯ (Python)ï¼š**
```python
BROKER_HOST = "127.0.0.1"
PORT = 1883
USER = "A_user" 
PASS = "A_password"  # setup.sh ä¸­è¨­ç½®
```

**B ç«¯ (C#)ï¼š**
```csharp
static string Host = "127.0.0.1";
static int Port = 1883;
static string User = "B_user";
static string Pass = "B_password";  // setup.sh ä¸­è¨­ç½®
```

## é–‹ç™¼æŒ‡å—

### æ¶ˆæ¯æ ¼å¼ç¯„ä¾‹

**é»ä½æŒ‡ä»¤ (Aâ†’B)ï¼š**
```json
{
  "type": "move_point",
  "point": {"x": 10.5, "y": -7.2},
  "ts": 1694678400,
  "sender": "A",
  "req_id": "uuid-string"
}
```

**åˆ†æçµæœ (Bâ†’A)ï¼š**
```json
{
  "type": "result_feature_set", 
  "features": ["Time_rms_y", "Time_skewness_y", "..."],
  "values": [1.23, -0.05, "..."],
  "point": {"x": 10.5, "y": -7.2},
  "req_id": "uuid-string",
  "ts": 1694678401,
  "sender": "B"
}
```

### æ“´å±•åŠŸèƒ½

**æ·»åŠ æ–°çš„ Topicï¼š**
1. åœ¨ `acl` æ–‡ä»¶ä¸­æ·»åŠ æ¬Šé™è¦å‰‡
2. åœ¨å®¢æˆ¶ç«¯ä»£ç¢¼ä¸­æ·»åŠ è¨‚é–±å’Œè™•ç†é‚è¼¯
3. é‡å•Ÿ MQTT Broker ä½¿ ACL ç”Ÿæ•ˆ

**TLS é…ç½®ï¼š**
1. å°‡æ†‘è­‰æ–‡ä»¶æ”¾å…¥ `broker/certs/` ç›®éŒ„
2. ä¿®æ”¹å®¢æˆ¶ç«¯é€£æ¥ç«¯å£ç‚º 8883
3. åœ¨å®¢æˆ¶ç«¯ä»£ç¢¼ä¸­æ·»åŠ  TLS è¨­ç½®

## æ•…éšœæ’é™¤

**å¸¸è¦‹å•é¡Œï¼š**

1. **é€£æ¥è¢«æ‹’çµ•ï¼š** æª¢æŸ¥ç”¨æˆ¶åå¯†ç¢¼æ˜¯å¦æ­£ç¢º
2. **æ¬Šé™éŒ¯èª¤ï¼š** ç¢ºèª `acl` æ–‡ä»¶é…ç½®å’Œç”¨æˆ¶æ¬Šé™
3. **æ¶ˆæ¯ä¸Ÿå¤±ï¼š** æª¢æŸ¥ QoS è¨­ç½®å’Œç¶²è·¯ç‹€æ³
4. **Docker å•Ÿå‹•å¤±æ•—ï¼š** ç¢ºèªç«¯å£æœªè¢«å ç”¨

**èª¿è©¦å‘½ä»¤ï¼š**
```bash
# æŸ¥çœ‹ Broker æ—¥èªŒ
docker compose -f broker/docker-compose.yml logs -f

# æ¸¬è©¦ MQTT é€£æ¥
mosquitto_pub -h 127.0.0.1 -p 1883 -u A_user -P A_password -t test -m "hello"

# ç›£è½æ‰€æœ‰æ¶ˆæ¯  
mosquitto_sub -h 127.0.0.1 -p 1883 -u A_user -P A_password -t '#' -v
```

## æ•ˆèƒ½èª¿å„ª

- **æ‰¹é‡è™•ç†**ï¼šå¯ä¿®æ”¹ A ç«¯æ”¯æŒä¸¦è¡Œç™¼é€å¤šå€‹é»ä½
- **æ¶ˆæ¯å£“ç¸®**ï¼šå°å¤§å‹çµæœæ•¸æ“šå¯è€ƒæ…®å£“ç¸®
- **å¿«å–æ©Ÿåˆ¶**ï¼šB ç«¯å·²å¯¦ç¾ `req_id` çµæœå¿«å–
- **QoS å„ªåŒ–**ï¼šæ ¹æ“šæ¥­å‹™éœ€æ±‚èª¿æ•´ QoS ç´šåˆ¥

## æˆæ¬Š

æ­¤å°ˆæ¡ˆåŸºæ–¼ MIT æˆæ¬Šæ¢æ¬¾ç™¼å¸ƒã€‚
